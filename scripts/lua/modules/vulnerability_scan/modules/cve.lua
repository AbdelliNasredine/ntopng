--
-- (C) 2020-23 - ntop.org
--

local vs_module = {}

package.path = dirs.installdir .. "/scripts/lua/modules/vulnerability_scan/?.lua;" .. package.path
local vs_utils = require("vs_utils")

-- ##############################################

function vs_module:new()
   local obj = { }

   setmetatable(obj, self)
   self.__index = self

   return obj
end

-- ##############################################

-- NOTE: ports are comma separated (e.g 80,443)

function vs_module:scan_host(host_ip, ports)
   local command = "nmap -sV --script vulscan --script-args vulscandb=cve.csv" -- <target> -p 80,233
   local scan_ports
   local scan_command
   
   if(isEmptyString(ports)) then
      scan_ports = ""
   else
      scan_ports = "-p " .. ports
   end
   
   scan_command = string.format("%s %s %s", command, host_ip, scan_ports)
   
   local begin_epoch = os.time()
   local handle = io.popen(scan_command)
   local result = handle:read("*a")
   handle:close()
   local duration = os.time() - begin_epoch
   local scan_ok = true
   
   return vs_utils.cleanup_nmap_result(result), duration, scan_ok
end

-- ##############################################

return vs_module

